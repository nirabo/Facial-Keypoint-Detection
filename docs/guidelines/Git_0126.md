# Git Workflow Guidelines

**Document Version:** 2.0
**Created:** October 25, 2025
**Last Updated:** January 6, 2026
**Status:** Active Standard

## Table of Contents

1. [Overview](#overview)
2. [Branching Strategy](#branching-strategy)
3. [Commit Message Standards](#commit-message-standards)
4. [Pull Request Process](#pull-request-process)
5. [Code Review Guidelines](#code-review-guidelines)
6. [Merge Strategies](#merge-strategies)
7. [Release Management](#release-management)
8. [Hotfix Process](#hotfix-process)
9. [Best Practices](#best-practices)

---

## Overview

This document establishes Git workflow standards for all repositories. Consistent Git practices ensure clean history, traceable changes, and efficient collaboration.

**Key Principles:**

- **Atomic Commits:** Each commit represents a single logical change
- **Clear History:** Commit messages explain why, not what
- **Branch Protection:** Main branch requires reviews and passing tests
- **Linear History:** Prefer rebase over merge for feature branches
- **Conventional Commits:** Standardized commit message format

---

## Branching Strategy

### Branch Types

We use a **simplified Git Flow** with the following branch types:

1. **main** - Production-ready code
2. **develop** - Integration branch for features (optional for smaller services)
3. **feature/** - New features
4. **fix/** - Bug fixes
5. **refactor/** - Code refactoring
6. **docs/** - Documentation updates
7. **hotfix/** - Production hotfixes
8. **release/** - Release preparation

### Branch Naming Convention

**Format:** `<type>/<ticket-id>-<short-description>`

**Examples:**

```bash
feature/DR-123-user-authentication
fix/DR-456-video-upload-error
refactor/DR-789-database-queries
docs/DR-012-api-documentation
hotfix/DR-999-security-patch
release/1.2.0
```

**Rules:**

- Use lowercase with hyphens
- Include ticket/issue ID when available
- Keep description short (2-4 words)
- Use descriptive names that explain the change

### Branch Lifecycle

```
main (production)
 │
 ├─→ feature/DR-123-new-feature
 │    │
 │    ├─→ (development)
 │    ├─→ (testing)
 │    └─→ PR → main
 │
 ├─→ fix/DR-456-bug-fix
 │    └─→ PR → main
 │
 └─→ hotfix/DR-999-critical-fix
      └─→ PR → main (expedited)
```

### Creating Branches

```bash
# Start from main
git checkout main
git pull origin main

# Create feature branch
git checkout -b feature/DR-123-user-authentication

# Push to remote
git push -u origin feature/DR-123-user-authentication
```

### Branch Protection Rules

**main branch MUST:**

- [ ] Require pull request reviews (minimum 1 approver)
- [ ] Require status checks to pass (tests, linting, security scans)
- [ ] Require branches to be up to date before merging
- [ ] Prevent force pushes
- [ ] Prevent deletion

**GitHub Branch Protection:**

```yaml
# Settings > Branches > Branch protection rules
Branch name pattern: main
- Require a pull request before merging
  - Require approvals: 1
  - Dismiss stale approvals
- Require status checks to pass
  - Require branches to be up to date
  - Status checks: lint, test, build
- Require conversation resolution
- Do not allow bypassing settings
```

---

## Commit Message Standards

### Conventional Commits Format

**Structure:**

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Example:**

```
feat(auth): add JWT token refresh mechanism

Implement automatic token refresh to improve user experience.
Tokens are refreshed 5 minutes before expiration.

Closes DR-123
```

### Commit Types

| Type         | Description                                 | Example                                      |
| ------------ | ------------------------------------------- | -------------------------------------------- |
| **feat**     | New feature                                 | `feat(api): add user search endpoint`        |
| **fix**      | Bug fix                                     | `fix(upload): handle large file timeouts`    |
| **docs**     | Documentation                               | `docs(readme): update installation steps`    |
| **style**    | Code style (formatting, missing semicolons) | `style(api): fix linting errors`             |
| **refactor** | Code refactoring                            | `refactor(db): optimize query performance`   |
| **perf**     | Performance improvement                     | `perf(video): reduce processing time by 30%` |
| **test**     | Add or update tests                         | `test(auth): add integration tests`          |
| **build**    | Build system changes                        | `build(docker): update base image`           |
| **ci**       | CI/CD changes                               | `ci(github): add security scanning`          |
| **chore**    | Maintenance tasks                           | `chore(deps): update dependencies`           |
| **revert**   | Revert previous commit                      | `revert: revert "feat(api): add search"`     |

### Commit Scope

Scope indicates the area of change:

- **api** - API endpoints
- **auth** - Authentication/authorization
- **db** - Database
- **ui** - User interface
- **core** - Core functionality
- **config** - Configuration
- **deps** - Dependencies

### Commit Subject

**Rules:**

- Use imperative mood ("add" not "added" or "adds")
- Don't capitalize first letter
- No period at the end
- Maximum 50 characters
- Be specific and descriptive

**Good:**

```
feat(api): add pagination to user list endpoint
fix(video): prevent duplicate frame processing
docs(api): document authentication flow
```

**Bad:**

```
Fixed bug
Updated code
Changes
WIP
asdfasdf
```

### Commit Body

**When to include body:**

- Complex changes requiring explanation
- Breaking changes
- Performance improvements with metrics
- Rationale for technical decisions

**Format:**

- Separate subject from body with blank line
- Wrap at 72 characters
- Explain WHAT and WHY, not HOW
- Use bullet points for multiple items

**Example:**

```
refactor(db): optimize video metadata queries

Query performance was degraded with large datasets (>100k videos).
Implemented the following optimizations:

- Added composite index on (user_id, created_at)
- Used select_related() for foreign keys
- Implemented query result caching (TTL: 5min)

Results in 85% faster query times (200ms → 30ms).

Refs: DR-456
```

### Commit Footer

**Breaking Changes:**

```
feat(api): change authentication to OAuth2

BREAKING CHANGE: API now requires OAuth2 tokens instead of API keys.
Clients must update authentication mechanism.

Migration guide: docs/oauth2-migration.md
```

**Issue References:**

```
Closes DR-123
Fixes DR-456
Refs DR-789
```

### Atomic Commits

**Each commit should:**

- Represent one logical change
- Be able to compile/run independently
- Include related tests
- Be revertable without side effects

**Good (Atomic):**

```bash
git commit -m "feat(auth): add user registration endpoint"
git commit -m "test(auth): add registration endpoint tests"
git commit -m "docs(api): document registration endpoint"
```

**Bad (Non-Atomic):**

```bash
git commit -m "add registration, fix login bug, update docs, refactor database"
```

---

## Pull Request Process

### Creating Pull Requests

**Before Creating PR:**

1. Ensure branch is up to date with main
2. Run all tests locally (`make test`)
3. Run linting (`make lint`)
4. Update documentation if needed
5. Add/update tests for changes

**PR Creation Checklist:**

```bash
# 1. Update branch
git checkout main
git pull origin main
git checkout feature/DR-123-user-auth
git rebase main

# 2. Run tests
make test
make lint
make type-check

# 3. Push changes
git push origin feature/DR-123-user-auth

# 4. Create PR via GitHub/GitLab UI
```

### PR Title Format

**Use conventional commit format:**

```
feat(auth): add JWT authentication

fix(video): resolve upload timeout issue

docs(api): add API versioning guide
```

### PR Description Template

**REQUIRED Template (.github/pull_request_template.md):**

```markdown
## Description

<!-- Brief description of changes -->

## Related Issues

<!-- Link to tickets/issues -->

Closes DR-123

## Type of Change

<!-- Mark with 'x' -->

- [ ] New feature (non-breaking change)
- [ ] Bug fix (non-breaking change)
- [ ] Breaking change (fix or feature that breaks existing functionality)
- [ ] Documentation update
- [ ] Refactoring
- [ ] Performance improvement

## Changes Made

<!-- Detailed list of changes -->

- Added JWT token generation
- Implemented token refresh mechanism
- Updated authentication middleware

## Testing

<!-- How was this tested? -->

- [ ] Unit tests added/updated
- [ ] Integration tests added/updated
- [ ] Manual testing completed
- [ ] Test coverage >80%

**Test Steps:**

1. Create user account
2. Login with credentials
3. Verify JWT token received
4. Access protected endpoint with token

## Documentation

<!-- Documentation updates -->

- [ ] README updated
- [ ] API documentation updated
- [ ] Code comments added
- [ ] Migration guide provided (if breaking change)

## Screenshots (if applicable)

<!-- Add screenshots for UI changes -->

## Checklist

- [ ] Code follows project style guidelines
- [ ] Self-reviewed code
- [ ] Commented complex sections
- [ ] No new warnings generated
- [ ] Tests pass locally
- [ ] Documentation updated
- [ ] No merge conflicts

## Additional Notes

<!-- Any additional context -->
```

### PR Size Guidelines

**SHOULD:**

- Keep PRs small (<400 lines changed)
- Split large features into multiple PRs
- Use feature flags for incremental releases

**Max Recommended Sizes:**

- **Small:** <100 lines (quick review, <30min)
- **Medium:** 100-400 lines (thorough review, 1-2 hours)
- **Large:** 400-1000 lines (requires multiple reviewers, split if possible)
- **Extra Large:** >1000 lines (must split into smaller PRs)

---

## Code Review Guidelines

### For Reviewers

**Review Checklist:**

- [ ] Code is understandable and maintainable
- [ ] Follows coding standards (Python, Docker, etc.)
- [ ] Tests cover new functionality
- [ ] No security vulnerabilities introduced
- [ ] Performance implications considered
- [ ] Documentation updated
- [ ] No unnecessary complexity
- [ ] Edge cases handled

**Review Comments:**

- Be respectful and constructive
- Explain WHY, not just WHAT
- Suggest specific improvements
- Distinguish between blocking and non-blocking comments

**Comment Prefixes:**

- **MUST:** Blocking issue that must be fixed
- **SHOULD:** Strong suggestion but not blocking
- **NIT:** Minor style/preference (non-blocking)
- **QUESTION:** Asking for clarification

**Example Comments:**

```
MUST: This function is vulnerable to SQL injection. Use parameterized queries.

SHOULD: Consider extracting this logic into a separate function for better testability.

NIT: Variable name could be more descriptive (e.g., `user_count` instead of `cnt`)

QUESTION: Why did you choose this algorithm over the standard approach?
```

### For Authors

**Responding to Reviews:**

- Address all comments (even NITs)
- Reply to each comment thread
- Mark conversations as resolved when addressed
- Request re-review after significant changes

**Handling Feedback:**

```
Reviewer: "MUST: Add validation for email format"
Author: "Fixed in commit abc123"

Reviewer: "SHOULD: Extract this to a utility function"
Author: "Good idea! Extracted to utils.validators in commit def456"

Reviewer: "NIT: Use f-string instead of format()"
Author: "Fixed in commit ghi789"
```

### Approval Requirements

**Minimum Approvals:**

- **Small PRs (<100 lines):** 1 approval
- **Medium PRs (100-400 lines):** 1 approval
- **Large PRs (>400 lines):** 2 approvals
- **Security/Critical PRs:** 2 approvals (including security team)

---

## Merge Strategies

### Merge Methods

**1. Squash and Merge (RECOMMENDED for feature branches)**

- Combines all commits into one
- Clean, linear history
- Lose individual commit history

```bash
# Via GitHub/GitLab: "Squash and merge" button

# Manual:
git checkout main
git merge --squash feature/DR-123-user-auth
git commit -m "feat(auth): add user authentication (DR-123)"
```

**When to use:**

- Feature branches with many small commits
- WIP commits that don't need to be preserved
- Most common case

**2. Rebase and Merge (for clean commit history)**

- Preserves individual commits
- Linear history
- Requires clean, atomic commits

```bash
# Update feature branch
git checkout feature/DR-123-user-auth
git rebase main

# Merge
git checkout main
git merge --ff-only feature/DR-123-user-auth
```

**When to use:**

- Well-structured commits worth preserving
- Small feature branches (2-5 commits)
- Clear commit messages

**3. Merge Commit (AVOID unless necessary)**

- Creates merge commit
- Preserves full history
- Cluttered history

**When to use:**

- Release branches
- Hotfixes that need to go to multiple branches
- Rarely

### Post-Merge Cleanup

```bash
# Delete feature branch locally
git branch -d feature/DR-123-user-auth

# Delete remote branch
git push origin --delete feature/DR-123-user-auth

# Or use GitHub/GitLab "Delete branch" option after merge
```

---

## Release Management

### Semantic Versioning

Follow **Semantic Versioning (SemVer)**: `MAJOR.MINOR.PATCH`

- **MAJOR:** Breaking changes (1.0.0 → 2.0.0)
- **MINOR:** New features (1.0.0 → 1.1.0)
- **PATCH:** Bug fixes (1.0.0 → 1.0.1)

**Pre-release Tags:**

- **alpha:** `1.0.0-alpha.1` (early testing)
- **beta:** `1.0.0-beta.1` (feature complete, testing)
- **rc:** `1.0.0-rc.1` (release candidate)

### Release Process

**1. Create Release Branch:**

```bash
git checkout main
git pull origin main
git checkout -b release/1.2.0
```

**2. Prepare Release:**

```bash
# Update version in files
vim pyproject.toml  # version = "1.2.0"
vim package.json    # "version": "1.2.0"

# Update CHANGELOG.md
vim CHANGELOG.md

# Commit version bump
git add .
git commit -m "chore(release): bump version to 1.2.0"
```

**3. Create Tag:**

```bash
git tag -a v1.2.0 -m "Release version 1.2.0"
git push origin v1.2.0
```

**4. Merge to Main:**

```bash
# Create PR from release/1.2.0 to main
# After approval and merge, tag main
git checkout main
git pull origin main
git tag -a v1.2.0 -m "Release version 1.2.0"
git push origin v1.2.0
```

### CHANGELOG.md Format

**Keep a Changelog format:**

```markdown
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added

- New feature in progress

## [1.2.0] - 2026-01-06

### Added

- JWT authentication with refresh tokens (DR-123)
- User profile management (DR-145)
- Search functionality (DR-178)

### Changed

- Improved database query performance by 85% (DR-156)
- Updated Docker base images to Python 3.12

### Fixed

- Upload timeout issue (DR-167)
- User profile update bug (DR-189)

### Security

- Patched SQL injection vulnerability (DR-199)

## [1.1.0] - 2025-09-15

### Added

- User authentication system
- Storage service

[Unreleased]: https://github.com/org/repo/compare/v1.2.0...HEAD
[1.2.0]: https://github.com/org/repo/compare/v1.1.0...v1.2.0
[1.1.0]: https://github.com/org/repo/releases/tag/v1.1.0
```

---

## Hotfix Process

**For critical production bugs:**

**1. Create Hotfix Branch:**

```bash
git checkout main
git pull origin main
git checkout -b hotfix/DR-999-security-patch
```

**2. Fix Issue:**

```bash
# Make fix
vim src/app/security.py

# Test thoroughly
make test

# Commit
git commit -m "fix(security): patch SQL injection vulnerability (DR-999)"
```

**3. Expedited Review:**

```bash
# Push and create PR
git push origin hotfix/DR-999-security-patch

# Request immediate review
# Requires 1 approval (expedited)
```

**4. Merge and Tag:**

```bash
# After approval, merge to main
# Bump patch version
git tag -a v1.2.1 -m "Hotfix: Security patch"
git push origin v1.2.1
```

**5. Deploy Immediately:**

```bash
# CI/CD deploys tagged version
# Monitor deployment
```

---

## Best Practices

### General Git Best Practices

**DO:**

- Commit early and often
- Write clear commit messages
- Keep commits atomic
- Pull before push
- Use branches for all changes
- Delete branches after merge
- Keep main branch deployable

**DON'T:**

- Commit directly to main
- Force push to shared branches
- Commit sensitive data (passwords, keys)
- Use generic commit messages
- Commit generated files
- Commit large binary files (use Git LFS)

### .gitignore Best Practices

**REQUIRED .gitignore sections:**

```gitignore
# Environment
.env
.env.*
!.env.example

# Python
__pycache__/
*.py[cod]
.pytest_cache/
.mypy_cache/
.ruff_cache/
*.egg-info/
.venv/
venv/

# Node.js
node_modules/
npm-debug.log*

# IDE
.vscode/
.idea/
*.swp

# OS
.DS_Store
Thumbs.db

# Build
dist/
build/
*.log

# Testing
.coverage
htmlcov/
coverage/

# Docker
docker-compose.override.yml
```

### Git Hooks

**Pre-commit Hook (RECOMMENDED):**

```bash
#!/bin/sh
# .git/hooks/pre-commit

# Run linting
make lint || exit 1

# Run type checking
make type-check || exit 1

# Run fast tests
make test-unit || exit 1

echo "Pre-commit checks passed"
```

**Install pre-commit:**

```bash
# Install pre-commit package
pip install pre-commit

# Create .pre-commit-config.yaml
# Install hooks
pre-commit install
```

**.pre-commit-config.yaml:**

```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files

  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.8.0
    hooks:
      - id: ruff
        args: [--fix, --exit-non-zero-on-fix]
      - id: ruff-format
```

---

## Summary Checklist

**Every repository MUST:**

### Branch Management

- [ ] Use feature branches (no direct commits to main)
- [ ] Follow branch naming convention
- [ ] Protect main branch
- [ ] Delete branches after merge

### Commits

- [ ] Use conventional commit format
- [ ] Write clear, descriptive messages
- [ ] Make atomic commits
- [ ] Reference issue IDs

### Pull Requests

- [ ] Use PR template
- [ ] Require minimum 1 approval
- [ ] Pass all CI/CD checks
- [ ] Keep PRs small (<400 lines)
- [ ] Squash and merge (default)

### Code Review

- [ ] Review all PRs before merge
- [ ] Address all review comments
- [ ] Use comment prefixes (MUST/SHOULD/NIT/QUESTION)
- [ ] Request re-review after changes

### Release Management

- [ ] Follow semantic versioning
- [ ] Maintain CHANGELOG.md
- [ ] Tag releases
- [ ] Create release branches for major versions

---

**Document maintained by:** Engineering Team
**Questions/Issues:** Open issue in respective repository or documentation repo
